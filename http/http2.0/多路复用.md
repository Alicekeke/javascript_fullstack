## I/O 多路复用

> 多路复用通常表示在一个信道上传输多路信号或数据流的过程和技术

多路复用就是很多网络连接(多路)，共(复)用少数几个(甚至是一个)线程。连接很多的时候，不能每个连接一个线程，会耗尽系统内存的。线程也不能阻塞在任何一个连接上，等新的数据来，这样就不能及时响应其他连接发来的数据了；也不能用非阻塞方式，轮询所有的连接，这会浪费掉大量CPU时间；只能告诉系统，我对哪些连接感兴趣，有消息来的时候，通知我处理。


多路复用是事件驱动，在事件驱动时 任务一定是单线程的，在同一条线程上，避免了大量的线程创建和切换


## http2.0 连接传输

从http0.9 到 HTTP2.0 要发送请求经历了
**多个tcp连接 -> keep-alive -> pipe line -> 多路复用**
不断的减少多次创建 Tcp 等等带来的性能损耗。
### http持久连接

HTTP持久连接可以重用已建立的TCP连接，减少三次握手的RTT延迟。浏览器在请求时带上 `connection: keep-alive `的头部，服务器收到后就要发送完响应后保持连接一段时间，浏览器在下一次对该服务器的请求时，就可以直接拿来用。

在使用持久连接后，客户端服务端连接不断开，所以之前的服务端在数据传输完成后根据响应判断数据是否传输完成就不再适合了，这就要求服务器对持久连接的响应头部一定要返回`content-length`标识body的长度，当然这样不准确，也可以使用 `Transfer-Encoding: chunked `头部发送一串一串的数据，最后由长度为0的chunked标识结束。

### http管线化

HTTP管线化可以克服同域**并行请求限制带来的阻塞**，它是建立在持久连接之上，是把所有请求一并发给服务器，但是服务器需要按照顺序一个一个响应，而不是等到一个响应回来才能发下一个请求，这样就节省了很多请求到服务器的时间。

不过，HTTP管线化仍旧有**队首阻塞**的问题，若上一响应迟迟不回，后面的响应都会被阻塞到。

### http2的多路复用

多路复用代替了http1.0的序列和阻塞机制，所有相同域名请求都是通过一个 TCP 连接**并发完成**。同一 Tcp 中可以发送多个请求，对端可以通过帧中的标识知道属于哪个请求，很好的解决了浏览器限制同一个域名下的请求数量的问题，避免http旧版队首阻塞的问题，极大地提高传输性能。

为什么能避免队首阻塞呢？

因为http2 中有两个很重要的概念，**流(stream)** 和** 帧(frame)**，     

之前我们http1的传输必须基于顺序传输，不能并行传输，不然接收方不知道传来文件的顺序。     
但在http有流和帧的概念，其中帧对数据进行标识，就可以按照序列对数据进行合并，而不会出现合并后数据错乱的情况      
而且http2.0创建新流默认是无限制的，也就是可以无限制的并行请求下载   


“流”在HTTP/2中是一个逻辑上的概念，就是说在一个TCP连接上，我们可以向对方不断发送一个个的消息，这里每一个消息看成是一帧（二进制分帧），而每一帧有个`stream identifier`的字段标明这一帧属于哪个“流”，然后在对方接收时，根据`stream identifier`拼接每个“流”的所有帧组成一整块数据。

我们把HTTP/1.x每个请求都当作一个“流”，那么请求化成多个流，请求响应数据切成多个帧，不同的流再交错发给对方，这就是HTTP/2中的多路复用。


### 以前我们做的性能优化不适用于HTTP/2了
- 小js，小css文件的合并，雪碧图（没用，http连接变得廉价了）
- 多域名文件分隔下载，（没用，反而dns解析时间边长，增加服务器压力）

[web性能优化与http/2](https://www.kancloud.cn/digest/web-performance-http2/74825)